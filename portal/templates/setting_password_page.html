{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Profile | Settings</title>
    <link rel="stylesheet" href="{% static 'portal/css/index.css' %}">
    <link rel="stylesheet" href="{% static 'portal/css/style_v1.css' %}">
    <link rel="stylesheet" href="{% static 'fontawesome/css/fontawesome_5_13.min.css' %}">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <!-- Sidebar Panel -->
    <div class="overlay hidden" onclick="toggleOverlay()" id="overlay_id"></div>
    <div class="flex">
        {% include 'sidebar.html' %}
        <!-- Settings Sidebar -->
        <div class="flex">
            <nav class="w-52 xl:ml-0 xl:w-44 bxl:w-52 h-auto ml-22 bg-gray-200 flex justify-center text-lg">
                <ul>
                    <li>
                        <center><p href="#" class="text-2xl bxl:text-xl bxl:mt-12 xl:text-lg mt-5 font-Lato font-bold">Settings</p></center> 
                    </li>
                    <div class="mt-20 flex-row space-y-8 xl:text-2base">
                        <li>
                            <span class="fas fa-pencil-alt mr-2 text-transparent bg-clip-text bg-gradient-to-r from-textGrad1 to-textGrad2 bxl:text-base"></span>
                            <a href="{% url 'portalSettingPage' %}" class="bxl:text-base font-Lato text-transparent bg-clip-text bg-gradient-to-r from-textGrad1 to-textGrad2">Edit Profile</a>  
                        </li>
                        <li>
                            <span class="fas fa-lock mr-2 bxl:text-base"></span>
                            <a href="{% url 'SettingPasswordPage' %}" class="font-Lato bxl:text-base">Password</a>    
                        </li>
                        <li>
                            <span class="fas fa-file-invoice-dollar mr-3 bxl:text-base"></span>
                            <a href="{% url 'SettingInvoicePage' %}" class="font-Lato bxl:text-base">Invoices</a>    
                        </li>
                        <li>
                            <span class="fas fa-key mr-1 bxl:text-base"></span>
                            <a href="{% url 'SettingPasswordManagementPage' %}" class="font-Lato bxl:text-base">Password Manager</a>    
                        </li>
                        <li>
                            <span class="fas fa-question-circle mr-1 bxl:text-base"></span>
                            <a href="{% url 'SettingFaqsPage' %}" class="font-Lato bxl:text-base">FAQs</a>    
                        </li>
                    </div>
                </ul>
            </nav>
        </div>
        <div class="">
            <nav class="bg-whiteSmoke text-white flex absolute right-0 justify-between items-center ml-0 m-8 h-20 xl:h-12 z-0 px-10 xl:px-0 mt-0 bxl:mt-2 xxl:mt-3">
                <ul class="flex items-center text-sm  text-gray-600">
                    <li class="flex items-center justify-center">
                        <a class="fas fa-search text-lg" href="#"></a>
                        <form action="">
                            <div class="h-10 flex items-center space-x-5 w-52">
                                <input class="w-full font-Poppins bxl:text-base bg-whiteSmoke text-black xl:py-1 xl:text-sm xxl:text-lg outline-0 py-4 px-5 text-lg" type="text" placeholder="Search">
                            </div>
                        </form>
                    </li>
                </ul>
                <ul class="flex items-center text-sm text-gray-600">
                    <div class="flex items-center justify-center space-x-5">
                        <li>
                            <a class="fas fa-bell text-lg ml-6 " href="#"></a>
                        </li>
                        <div class="flex items-center justify-center">
                            <li>
                                <a href="#">
                                    <img src="https://img.icons8.com/dusk/100/000000/user-female-circle.png" class="object-scale-down h-10 w-20 rounded-full"> 
                                </a>
                            </li>
                            
                            <li class="text-lg xl:text-sm xxl:text-lg">
                                <p class="font-Jost">{{ profile_details.first_name }} {{ profile_details.last_name }}</p>
                            </li>
                        </div>
                        <li class="">
                            <a class="fas fa-chevron-down text-lg ml-3" href="#"></a>
                        </li>
                    </div>
                </ul>
            </nav>
        </div>
        
        <div class="w-full xxl:ml-32 xxl:mt-20">
            <div class="mt-32 bxl:mt-16 xl:mt-10 ml-5 flex">
                <div>
                    <h1 class="text-4xl xl:text-2xl font-Poppins text-editProfile"><b>Edit Password</b></h1>
                </div>
                <div class="pw-form1 w-120 mt-20 xl:mt-20  text-center place-content-center bxl:ml-20">
                        <label class="font-Poppins font-semibold bxl:text-base text-2base" id="processing_status" style="color: #ae87ed; display: none;">Processing . . . </label><br>
                        <label class="font-Poppins font-semibold bxl:text-base text-2base">Current Password</label><br>
                        <input required class="w-105 p-2 text-lg xl:w-85 rounded-2xl bg-gray-50 border border-gray-300" type="password" name="current_password" id="current_password">
                        <br><label class="font-Poppins font-semibold bxl:text-base text-2base">New Password</label><br>
                        <input required class="w-105 p-2 text-lg xl:w-85 rounded-2xl bg-gray-50 border border-gray-300" type="password" name="new_password" id="new_password" >
                        
                        <div class="mt-5 text-start xl:ml-20 font-Poppins text-sm bxl:text-2base">
                            <h3 class="font-Poppins ">* 6 characters minimum</h3>
                            <h3 class="font-Poppins ">* Must contain one number</h3>
                            <h3 class="font-Poppins ">* One uppercase</h3><br>
                        </div>

                        <label class="font-Poppins font-semibold bxl:text-base text-2base">Confirm New Password</label><br>
                        <input required class="w-105 p-2 text-lg xl:w-85 rounded-2xl bg-gray-50 border border-gray-300" type="password" name="confirm_password" id="confirm_password">
                        <!-- onclick="togglePopup()" -->
                        <div class="flex space-x-4 w-120 bxl:mt-12 xl:mt-5 justify-center items-center">
                            <button onclick="check_password()" id="pw_btn" class="w-20 cursor-pointer mt-12 xl:mt-0 p-1 rounded-full bxl:p-1 bxl:w-32 text-lg xl:text-sm xl:p-0 text-white bg-gradient-to-r from-linearButton1 to-linearButton2 transition-all duration-500 font-Poppins">Save</button>
                            <button type="button" class="w-20 mt-12 xl:mt-0 p-1 rounded-full bxl:p-1 bxl:w-32 text-lg xl:text-sm xl:p-0 text-black transition-all bg-gray-50 border-2 border-gray-300 duration-500 font-Poppins">Reset</button>
                        </div>
                    
                </div>
            </div>
        </div>
    </div>
    <div id="popup-1" class="popup bg-white w-120 h-52 flex-col text-center items-center justify-center absolute z-10">
        <h1 class="text-lg xl:mt-5 font-Poppins" id="processing_otp" style="color: #ae87ed; display: none;">Processing . . . </h1>
        <h1 class="text-lg xl:mt-5 font-Poppins">Enter the OTP code that was sent to your Email.</h1>
        <form>
            <div class=" otp-field mt-5 flex items-center justify-center space-x-4 text-lg ">
                <input class="otp-box" id="otp_number_1" name="otp_number_1" type="number"/>
                <input class="otp-box" id="otp_number_2" name="otp_number_2" type="number" disabled/>
                <input class="otp-box" id="otp_number_3" name="otp_number_3" type="number" disabled/>
                <input class="otp-box" id="otp_number_4" name="otp_number_4" type="number" disabled/>
            </div>
            <div class="mt-5 space-x-4 ">
               <button type="button" onclick="changepassword()" class="otp-verify mt-12 xl:mt-0 xl:w-20 xl:text-sm xl:p-0 p-1 kxl:p-3 kxl:text-4xl txl:text-xl w-full rounded-full text-lg text-white font-Poppins bg-gradient-to-r from-linearButton1 to-linearButton2 transition-all duration-500">Submit</button>

                <button type="reset" onclick="toggleCancel()" class="mt-12 xl:mt-0 xl:w-20 xl:text-sm xl:p-0 p-1 kxl:p-3 kxl:text-4xl txl:text-xl w-full rounded-full text-lg text-white font-Poppins bg-gradient-to-r from-linearButton1 to-linearButton2 transition-all duration-500">Cancel</button>
            </div>
            <p class="text-sm bxl:text -2base mt-3 font-Poppins ">Didn't receive a code? <b><a href="#" class="font-Poppins">Resend</a></b></p>
        </form>    
    </div>
    <div id="popup-2" class="popup bg-white w-120 h-52 flex-col text-center items-center justify-center absolute xl:p-5 z-10">
        <h1 class="text-lg font-bold xl:mt-5 font-Poppins text-editProfile">New Password Saved!</h1>
        <p class="text-base font-Poppins xl:mt-3">We recommend to save your password on our Password Manager.</p>
        <div class="flex justify-center items-center space-x-4">
            <button type="button" onclick="togglePwSaveToDb()" class="mt-12 xl:mt-8 xl:w-25 xl:text-sm xl:p-1 p-1 kxl:p-3 kxl:text-4xl txl:text-xl w-full rounded-full font-Poppins text-2base text-white bg-gradient-to-r from-linearButton1 to-linearButton2 transition-all duration-500">Save</button>

            <button type="reset" onclick="toggleCancel()" class="mt-12 xl:mt-8 xl:w-25 xl:text-sm xl:p-1 p-1 kxl:p-3 kxl:text-4xl txl:text-xl w-full rounded-full font-Poppins text-2base text-black  bg-gray-50 border-2 border-gray-300 ">Cancel</button>
        </div>
    </div>
    <div id="popup-3" class="popup bg-white w-120 h-52 absolute flex flex-col justify-center items-center text-center xl:px-10 xl:pt-6 z-10">
        <h1 class="text-lg font-bold  font-Poppins text-editProfile">Your Password was saved on our Password Manager</h1>
        <div class="flex justify-center items-center space-x-4">
            <a href="stng_pwmngr.html" class="mt-12 xl:mt-16 xl:w-32 xl:text-sm xl:p-1 p-1 kxl:p-3 kxl:text-4xl txl:text-xl w-full rounded-full font-Poppins text-xsm text-white bg-gradient-to-r from-linearButton1 to-linearButton2 transition-all duration-500">View Passwords</a>
            <a href="stng_profile.html" onclick="toggleCancel()" class="mt-12 xl:mt-16 xl:w-40 xl:text-sm xl:p-1 p-1 kxl:p-3 kxl:text-4xl txl:text-xl w-full rounded-full font-Poppins text-xsm text-black  bg-gray-50 border-2 border-gray-300 cursor-pointer">Back to Dashboard</a>
        </div>
    </div>
    <div id="popup-4" class="popup bg-white w-120 h-40 flex-col text-center items-center justify-center absolute z-10">
        <h1 class="text-lg xl:mt-5 font-Poppins" id='error_password'>Current password and </h1>
        <div class="mt-5 space-x-4 ">
            <button type="reset" onclick="error_cancel()" class="mt-12 xl:mt-0 xl:w-20 xl:text-sm xl:p-0 p-1 kxl:p-3 kxl:text-4xl txl:text-xl w-full rounded-full text-lg text-white font-Poppins bg-gradient-to-r from-linearButton1 to-linearButton2 transition-all duration-500">Cancel</button>
        </div>
    </div>
    <input type="hidden" name="send_otp" id="send_otp" value="0">
    <script src="{% static 'portal/js/uploadImg.js' %}"></script>
    <script src="{% static 'portal/js/enableBtn.js' %}"></script>
    <script type="text/javascript" src="{% static 'portal/js/jquery_3.7.0.js' %}"></script>
    <script type="text/javascript">
        function check_password(){
            $("#processing_status").show();
            var current_password = $("#current_password").val();
            var new_password = $("#new_password").val();
            var confirm_password = $("#confirm_password").val();
            $("#error_password").empty();
            if(current_password == ""){
                alert("Current Password should not be empty!");
                $("#current_password").focus();
                $("#processing_status").hide();
                return false;
            } 
            if(new_password == ""){
                alert("New password should not be empty!");
                $("#new_password").focus();
                $("#processing_status").hide();
                return false;
            } 
            if(confirm_password == ""){
                alert("confirm password should not be empty!");
                $("#confirm_password").focus();
                $("#processing_status").hide();
                return false;
            }

            if(new_password != confirm_password){
                $("#error_password").append('New password and current password does not match!');
                document.getElementById("popup-4").classList.toggle("active");
                document.getElementById("overlay_id").classList.toggle("active");
                $("#processing_status").hide();
                return false;
            }

            if(validatePassword(new_password)){
                changepassword();
            }
        }

        function changepassword(){
            var send_otp = $("#send_otp").val();
            if(send_otp != 0){
                $("#processing_otp").show();
                var otp_number_1 = $("#otp_number_1").val();
                if(otp_number_1.length == 0){
                    alert("please input the otp code.");
                    $("#processing_otp").hide();
                    return false;
                }
                var otp_number_2 = $("#otp_number_2").val();
                if(otp_number_2.length == 0){
                    alert("please input the otp code.");
                    $("#processing_otp").hide();
                    return false;
                }
                var otp_number_3 = $("#otp_number_3").val();
                if(otp_number_3.length == 0){
                    alert("please input the otp code.");
                    $("#processing_otp").hide();
                    return false;
                }
                var otp_number_4 = $("#otp_number_4").val();
                if(otp_number_4.length == 0){
                    alert("please input the otp code.");
                    $("#processing_otp").hide();
                    return false;
                }
                var otp = otp_number_1+""+otp_number_2+""+otp_number_3+""+otp_number_4;
                $.ajax({
                    type: "POST",
                    url: "{% url 'changePassword' %}",
                    data: {
                            "csrfmiddlewaretoken": '{{ csrf_token }}',
                            "userId": '{{ request.user.id }}',
                            "new_password": $("#new_password").val(),
                            "otp": otp,
                    },
                    async:true,
                    success: function (data) {
                        if(data.success != 0){
                            $("#processing_otp").hide();
                            alert("update successful!");
                            // toggleSuccess();
                            // $("#success_msg").show();
                            // you need to logout the client and redirect the to the login page
                            // maybe after popup-3
                            window.location.replace("{{ site_url }}{% url 'accountLogout' %}");
                        }else{
                            if(data.error_msg != ""){
                                $("#processing_otp").hide();
                                alert(data.error_msg);
                            }
                        }                    
                    },
                    error: function (e) {
                        $("#processing_otp").hide();
                        alert("Error! please try again later.");
                    }
                })
            }else{
                $.ajax({
                    type: "POST",
                    url: "{% url 'passwordResetOtp' %}",
                    data: {
                            "csrfmiddlewaretoken": '{{ csrf_token }}',
                            "userId": '{{ request.user.id }}',
                            "current_password": $("#current_password").val(),
                            "new_password": $("#new_password").val(),
                        },
                    async:true,
                    success: function (data) {
                        if(data.success != 0){
                            $("#send_otp").val(1);
                            togglePopup();
                            $("#processing_status").hide();
                        }else{
                            alert(data.status)
                            $("#processing_status").hide();
                        }
                        
                    },
                    error: function (e) {
                        $("#processing_status").hide();
                        alert("Error! please try again later.");
                    }
                })
            }
            
        }

        function error_cancel(){
            document.getElementById("popup-4").classList.remove("active");
            document.getElementById("overlay_id").classList.toggle("active");
        }

        function validatePassword(password) {
            var spChars = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]+/;
            var capital_letter = /[A-Z]+/;
            var passw=  /^[A-Za-z]\w{7,14}$/;
            if (password.length < 8) {
                alert("Your password must be at least 8 characters");
                $("#processing_status").hide();
                return false;
            }
            if (password.search(/[a-z]/i) < 0) {
                alert("Your password must contain at least one letter.");
                $("#processing_status").hide();
                return false;
            }
            if (capital_letter.test(password) == false) {
                alert("Your password must contain at least one capital letter.");
                $("#error_msg").show();
                $("#processing_status").hide();
                return false;
            }
            if (password.search(/[0-9]/) < 0) {
                alert("Your password must contain at least one digit.");
                $("#processing_status").hide();
                return false;
            }
            if (spChars.test(password) == false){
                alert("Your password must contain at least one special characters.");
                $("#processing_status").hide();
                return false;
            }
            return true;
        }
        
    </script>
</body>
</html>