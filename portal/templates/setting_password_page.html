{% load static %}
<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Password</title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@1,700&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="{% static 'portal/css/navbar.css' %}">
	<link rel="stylesheet" href="{% static 'portal/css/profile.css' %}">
	<link rel="stylesheet" href="{% static 'fontawesome/css/all.css' %}">
</head>
<body style="background:#F5F6FA;">
	<div class="row" id="body-row">
		{% include 'sidebar_v1.html' %}
		<div class="col main-container" style="padding-left: 0px;">
			<div class="row">
				{% include 'setting_sub_menu.html' %}
				<div class="col main-container">
					<div class="container-fluid">
						<br/>
						<div class="row search_bar_wrapper">
    						<div class="col-sm-10"></div>
							<div class="col-sm-2" style="text-align:right; margin: auto;">
								<i class="fas fa-fw fa-bell"></i> <span class="indicator"></span>
								<span>
									<img src="https://img.icons8.com/dusk/100/000000/user-female-circle.png" alt="" class="user-avatar-md rounded-circle" width="25px">
									{{ profile_details.first_name }} {{ profile_details.last_name }}
			    					<span class="dropdown">
										<span class="fa-solid fa-angle-down" type="button" id="Account-menu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></span>
										<div class="dropdown-menu dropdown-menu-right" aria-labelledby="Account-menu">
											<button class="dropdown-item" type="button">Account</button>
										    <button class="dropdown-item" type="button">Settings</button>
										    <button class="dropdown-item" type="button">Logout</button>
										</div>
									</span>
								</span>
							</div>
    					</div>
						<form id="change_password_form" method="POST">
							<div class="row">
								<div class="col-sm-12">
									<span class="edit_profile_text">Edit Password <li class="far fa-edit"></li></span>
								</div>
							</div>
							<div class="row">
								<div class="col-sm-3"></div>
								<div class="col-sm-6">
								<br/><br/>
									<div class="alert alert-warning" id="error_msg" style="display:none;" role="alert"></div>
									<div class="alert alert-success" role="alert" id="success_msg" style="display:none;"></div>
									<div class="row">
										<div class="col-sm-12" style="text-align: center;">
											<span class="password_setting_label">Current Password</span>
										</div>
										<input class="form-control current_password" type="password" name="current_password" id="current_password" value="">
									</div>
									<br/>
									<div class="row">
										<div class="col-sm-12" style="text-align: center;">
											<spanspan class="password_setting_label">New Password</span>
										</div>
										<input class="form-control current_password" type="password" name="new_password" id="new_password" value="">
									</div>
									<div class="row">
										<div class="col-sm-12">
											<p style="font-size:13px;">
												8 characters minimum<br/>
												must contain one number<br/>
												one uppercase<br/>
											</p>
										</div>
									</div>
									<div class="row">
										<div class="col-sm-12" style="text-align: center;">
											<spanspan class="password_setting_label">Confirm New Password</span>
										</div>
										<input class="form-control current_password" type="password" name="confirm_password" id="confirm_password" value="">
									</div>
									<div class="row">
										<p style="font-size:13px;">Please Put the code that was sent to your email to change password</p>
									</div>
									<div class="row">
										<div class="col-sm-12" style="text-align: center;">
											<span class="password_setting_label">OTP</span>
										</div>
										<div class="col-sm-2"></div>
										<div class="col-sm-8">
											<input class="form-control current_password" type="text" name="OTP" id="OTP" value="">
											<input type="hidden" name="sent_otp" id="sent_otp" value="0">
										</div>
										<div class="col-sm-2"></div>
										
										<div class="col-sm-2"></div>
										<div class="col-sm-8">
											<p style="font-size:13px; display:none; color:red;" class="otp_warning_label">OTP should not be empty</p>
										</div>
										<div class="col-sm-2"></div>
											
										
									</div><br/>
									
								</div>
								<div class="col-sm-3"></div>
							</div>
						</form>
						<div class="row">
							<div class="col-sm-12">
								<div class="row">
									<div class="col-sm-4"></div>
									<div class="col-sm-2">
										<button type="submit" class="password_save_btn" onclick="password_change_save_btn()">Save</button>
									</div>
									<div class="col-sm-2">
										<a href="{% url 'portalDashboard' %}">
											<button type="button" class="profile_cancel_btn">Cancel</button>
										</a>
									</div>
									<div class="col-sm-4"></div>
								</div>
								
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
	<script src="{% static 'portal/js/portalnavbar.js' %}"></script>
	<script type="text/javascript">
		function password_change_save_btn(){
		var sent_otp = $("#sent_otp").val();
		var otp = $("#OTP").val();
		var site_url = $("#site_url").val();
		$(".otp_warning_label").empty();
		$("#error_msg").empty();
		$("#error_msg").hide();
		$("#success_msg").empty();
		$("#success_msg").hide();
		if(sent_otp != 0){
			if (otp.length == 6){
				$.ajax({
			        type: "POST",
			        url: "{% url 'changePassword' %}",
			        data: {
			        		"csrfmiddlewaretoken": '{{ csrf_token }}',
			        		"userId": '{{ request.user.id }}',
			        		"new_password": $("#new_password").val(),
			        		"otp": otp,
			    		},
			        async:true,
			        success: function (data) {
			        	if(data.success != ""){
			        		$("#success_msg").append(data.success);
			            	$("#success_msg").show();
			            	window.location.replace(site_url+"{% url 'accountLogin' %}")
			        	}else{
			        		if(data.error_msg != ""){
			        			$("#error_msg").append(data.error_msg)
								$("#error_msg").show();
			        		}
			        	}
			            
			            
			        },
			        error: function (e) {
			            $("#error_msg").append("Error! please try again later.");
			        }
			    })
			}else{
				$("#error_msg").append("Invalid otp!")
				$("#error_msg").show();
				return false;
			}
		}else{
			var new_password = $("#new_password").val();
			var confirm_password = $("#confirm_password").val();
			var password_valid = validatePassword(new_password)
			if(password_valid && new_password != ""){
				if(new_password == confirm_password){
					$.ajax({
				        type: "POST",
				        url: "{% url 'passwordResetOtp' %}",
				        data: {
				        		"csrfmiddlewaretoken": '{{ csrf_token }}',
				        		"userId": '{{ request.user.id }}',
				        		"current_password": $("#current_password").val(),
				        		"new_password": $("#new_password").val(),
				    		},
				        async:true,
				        success: function (data) {
				            $("#success_msg").append(data.status);
				            $("#success_msg").show();
				            $("#sent_otp").val(1);
				        },
				        error: function (e) {
				            $("#error_msg").append("Error! please try again later.");
				            $("#error_msg").show();
				        }
				    })
				}else{
					$("#error_msg").append("Your password does not match!");
					$("#error_msg").show();
	                return false;
				}
			}
		}
	}

	function validatePassword(password) {
            var spChars = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]+/;
            var capital_letter = /[A-Z]+/;
            if (password.length < 8) {
                $("#error_msg").append("Your password must be at least 8 characters");
                $("#error_msg").show();
                return false;
            }
            if (password.search(/[a-z]/i) < 0) {
                $("#error_msg").append("Your password must contain at least one letter.");
                $("#error_msg").show();
                return false;
            }
            if (capital_letter.test(password) == false) {
                $("#error_msg").append("Your password must contain at least one capital letter.");
                $("#error_msg").show();
                return false;
            }
            if (password.search(/[0-9]/) < 0) {
                $("#error_msg").append("Your password must contain at least one digit."); 
                $("#error_msg").show();
                return false;
            }

            if (spChars.test(password) == false){
                $("#error_msg").append("Your password must contain at least one special characters."); 
                $("#error_msg").show();
                return false;
            }
            return true;
        }
	</script>
</body>
</html>